name: Release to Maven Central

on:
  release:
    types: [ created ]
  workflow_dispatch:
    inputs:
      git_tag:
        description: 'The Git tag to release from (e.g., v1.2.3)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_tag || github.ref }}

      - name: Set up JDK 17, GPG, and Maven Settings
        uses: actions/setup-java@v4
        with:
          # Use JDK 17 to build (it can cross-compile to 8 easily).
          # This ensures compatibility with the latest Maven plugins.
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

          # 1. Configure GPG automatically
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}

          # 2. Configure settings.xml automatically
          server-id: central
          server-username: MAVEN_CENTRAL_USERNAME
          server-password: MAVEN_CENTRAL_TOKEN

      - name: Publish to Maven Central
        env:
          # Map the secrets to environment variables so setup-java can inject them
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
        run: |
          # We use 'verify' to build/test/sign, then 'central-publishing:publish' to upload.
          # We do NOT use 'deploy' because we lack <distributionManagement> in the POM.
          mvn -B clean verify central-publishing:publish \
            -Pjdk9+ \
            -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}